<?xml version="1.0" encoding="UTF-8" ?>

<Module>
  <ModulePrefs title="Time Tracker" author="Reed Wilson">
    <Require feature="google.calendar-0.5.read"/>
  </ModulePrefs>
  <Content type="html">
    <![CDATA[
      <html>
        <script type="text/javascript">
          window.addEventListener("DOMContentLoaded", function() {
            doWork();
          }, false);

          // finds the hours for a given event
          var getTime = function(start, end) {
            return (end - start) / 1000 / 60 / 60;
          }

          // parses the tag and time out of the details
          var parseTag = function(details) {
            console.log('details: ' + details);
            var re = /tags:\s*(\S+)/i;
            var arr = re.exec(details);
            if (arr)
              return arr[1];
          }

          // builds the html table that will display the data
          var buildTable = function(tags) {
            var output = '<table><tbody>';
            for (tag in tags) {
              output += '<tr><td>' + tag + '</td><td>' + tags[tag] + '</td></tr>';
            }
            output += '</tbody></table>';
            return output;
          }

          var convertDate = function(date) {
            return google.calendar.utils.toDate(date);
          }

          function eventCallback(response) {
            // get a collection of tags and the time associated with the tags
            // { name0: float, name1: float }

            var tags = {};
            console.log('events: ' + response[0].events.length);
            for (event in response[0].events) {
              var tag = parseTag(event.details);
              var time = getTime(convertDate(event.startTime), convertDate(event.endTime));
              console.log(tag + " " + time);
              if (!(tag in tags)) {
                tags[tag] = time;
              } else {
                tags[tag] += time;
              }
            }

            console.log('tags: ' + Object.keys(tags).length);
            output = buildTable(tags);
            document.getElementById('content_div').innerHTML = output;
          }

          function doWork() {
            // get current week
            var startDate = {year: 2015, month: 1, date : 4, hour : 0, minute:0, second: 0};
            var endDate = {year: 2015, month: 1, date : 11, hour : 0, minute: 0, second: 0};

            google.calendar.read.getEvents(eventCallback, ["reedcwilson@gmail.com"], startDate, endDate, {'requestedFields': ['owner', 'status', 'attendeeCount', 'details']});
          }

        </script>

        <div id="content_div"></div>
      </html>
    ]]>
  </Content>
</Module>
